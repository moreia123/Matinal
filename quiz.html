<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Rotina Matinais Maxcell</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALiQ04FR2WZpaEkR20HUr1AVDS31QBQkU",
            authDomain: "matinal-3dab3.firebaseapp.com",
            projectId: "matinal-3dab3",
            storageBucket: "matinal-3dab3.firebasestorage.app",
            messagingSenderId: "168000386914",
            appId: "1:168000386914:web:f0f71c16e81e974586de3b",
            measurementId: "G-XFC6LTQ7VL"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
</head>
<body>
    <div class="container">
        <h1>Quiz: <span id="quiz-day"></span></h1>
        <div id="login">
            <h2>Cadastro de Vendedor</h2>
            <form id="login-form">
                <label for="nome">Nome:</label>
                <input type="text" id="nome" placeholder="Digite seu nome" required>
                <label for="cpf">CPF:</label>
                <input type="text" id="cpf" placeholder="Digite seu CPF" required>
                <button type="submit">Iniciar Quiz</button>
            </form>
        </div>
        <div id="quiz" style="display: none;">
            <div id="questions"></div>
            <div class="timer" id="timer">10</div>
            <div id="result"></div>
        </div>
    </div>

    <script>
        let vendedor = null;

        // Função para cadastrar ou buscar vendedor
        function cadastrarVendedor(nome, cpf) {
            return database.ref('vendedores').orderByChild('cpf').equalTo(cpf).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // Vendedor já cadastrado
                        const data = snapshot.val();
                        vendedor = {
                            id: Object.keys(data)[0],
                            nome: data[Object.keys(data)[0]].nome,
                            cpf: cpf
                        };
                    } else {
                        // Cadastra novo vendedor
                        const novoVendedor = {
                            nome: nome,
                            cpf: cpf
                        };
                        return database.ref('vendedores').push(novoVendedor)
                            .then((ref) => {
                                vendedor = {
                                    id: ref.key,
                                    nome: nome,
                                    cpf: cpf
                                };
                            });
                    }
                });
        }

        // Função para iniciar o quiz
        document.getElementById('login-form').addEventListener('submit', function (event) {
            event.preventDefault();

            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value;

            cadastrarVendedor(nome, cpf)
                .then(() => {
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('quiz').style.display = 'block';
                    const urlParams = new URLSearchParams(window.location.search);
                    const day = urlParams.get('day');
                    loadQuestions(day); // Carrega as perguntas do dia selecionado
                })
                .catch((error) => {
                    alert("Erro ao cadastrar vendedor: " + error.message);
                });
        });

        // Função para carregar as perguntas do quiz
        function loadQuestions(day) {
            const questionsRef = database.ref(`perguntas/${day}`);
            questionsRef.once('value').then((snapshot) => {
                const questions = snapshot.val();
                if (questions) {
                    displayQuestion(questions, 0); // Exibe a primeira pergunta
                    startTimer(); // Inicia o timer
                } else {
                    alert("Nenhuma pergunta encontrada para este dia.");
                }
            }).catch((error) => {
                alert("Erro ao carregar perguntas: " + error.message);
            });
        }

        // Função para exibir uma pergunta
        function displayQuestion(questions, index) {
            const question = questions[index];
            const questionsDiv = document.getElementById('questions');
            questionsDiv.innerHTML = `
                <h3>${question.pergunta}</h3>
                <ul>
                    ${question.opcoes.map((opcao, i) => `
                        <li>
                            <button onclick="checkAnswer(${i}, ${index})">${opcao}</button>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // Função para verificar a resposta
        function checkAnswer(answerIndex, questionIndex) {
            const question = questions[questionIndex];
            if (answerIndex === question.respostaCorreta) {
                alert("Resposta correta!");
            } else {
                alert("Resposta incorreta!");
            }
            // Avança para a próxima pergunta
            if (questionIndex + 1 < questions.length) {
                displayQuestion(questions, questionIndex + 1);
            } else {
                alert("Quiz concluído!");
                saveResults();
            }
        }

        // Função para salvar os resultados no Firebase
        function saveResults() {
            const results = {
                vendedor: vendedor.nome,
                cpf: vendedor.cpf,
                respostas: questions.map((question, index) => ({
                    pergunta: question.pergunta,
                    resposta: question.respostaCorreta
                }))
            };
            database.ref(`respostas/${day}`).push(results)
                .then(() => {
                    alert("Resultados salvos com sucesso!");
                })
                .catch((error) => {
                    alert("Erro ao salvar resultados: " + error.message);
                });
        }

        // Função para iniciar o timer
        function startTimer() {
            let timeLeft = 10;
            const timerDiv = document.getElementById('timer');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDiv.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Tempo esgotado!");
                    saveResults();
                }
            }, 1000);
        }
    </script>
</body>
</html>
